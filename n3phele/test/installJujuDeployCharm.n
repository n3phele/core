# installJujuDeployCharm.n
# Author: Lucas Pugens
name	   :  installJujuDeployCharm
description: install Juju on a virtual machine, initialize if do not exists the bootstrap and deploy a charm
version	   : 0.3.5
preferred  : true
public	   : true
icon	   : http://www.n3phele.com/icons/custom
parameters :
	int n	= 1 	# how many to create
	string juju_version = "0.6" #version to download of juju
	string charm = "nyancat" #charm to deploy
	string charm_name = "nyan01" #a name to deployed charm
	boolean bootstrap_ready = false #set if you already had set up the server 0 for juju
input files:
	environments.yaml # Input file to configure juju
	juju_sshKey_input.key #ssh key if you already have a bootstrap machine
output files:
	juju_sshKey.key # Output ssh key to access the bootstrap
EC2: # Amazon EC2
	$$my_vmPugens = CREATEVM --name myVM --n $$n
	ON $$my_vmPugens sudo apt-get -y install python-software-properties
	ON $$my_vmPugens sudo add-apt-repository -y ppa:juju/$$juju_version
	ON $$my_vmPugens sudo apt-get update -y && sudo apt-get install -y -qq juju
	ON $$my_vmPugens mkdir ~/.juju/
	ON $$my_vmPugens mv environments.yaml ~/.juju/environments.yaml
	ON $$my_vmPugens chmod go-rxw ~/.juju/environments.yaml
	ON $$my_vmPugens ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
	ON $$my_vmPugens --produces [juju_sshKey.txt: output/juju_sshKey.txt] if $$bootstrap_ready ; then mv juju_sshKey_input.key ~/.ssh/id_rsa; else ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""; mkdir output; cp ~/.ssh/id_rsa output/juju_sshKey.txt; juju bootstrap; fi
	ON $$my_vmPugens juju deploy $$charm $$charm_name << EOF
		yes
	EOF
HPZone1: # HP Cloud
	$$my_vmPugens = CREATEVM --name myVM --n $$n
	ON $$my_vmPugens sudo apt-get -y install python-software-properties
	ON $$my_vmPugens sudo add-apt-repository -y ppa:juju/$$juju_version
	ON $$my_vmPugens sudo apt-get update -y && sudo apt-get install -y -qq juju
	ON $$my_vmPugens mkdir ~/.juju/
	ON $$my_vmPugens mv environments.yaml ~/.juju/environments.yaml
	ON $$my_vmPugens chmod go-rxw ~/.juju/environments.yaml
	ON $$my_vmPugens --produces [juju_sshKey.txt: output/juju_sshKey.txt] if $$bootstrap_ready ; then mv juju_sshKey_input.key ~/.ssh/id_rsa; else ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""; mkdir output; cp ~/.ssh/id_rsa output/juju_sshKey.txt; juju bootstrap; fi
	ON $$my_vmPugens juju deploy $$charm $$charm_name << EOF
		yes
	EOF
